{"version":3,"sources":["../../../app/controller/menu.js"],"names":["Controller","require","MenuController","arguments","roleMenuSql","token","ctx","request","header","service","redis","get","roles","user","tree","length","app","mysql","query","map","r","id","_menuTree","body","i","current","children","load_method","method","split","module","exports"],"mappings":";;;;;;;;;;;;AAAA,IAAMA,aAAWC,QAAQ,KAAR,EAAeD,UAAhC;;IAEME,c;;;AAEF,8BAAa;AAAA;;AAAA,qIACAC,SADA;;AAET,cAAKC,WAAL;AAFS;AAKZ;;;;;;;;;;;;AAGSC,qC,GAAO,KAAKC,GAAL,CAASC,OAAT,CAAiBC,MAAjB,CAAwB,cAAxB,C;;uCACY,KAAKC,OAAL,CAAaC,KAAb,CAAmBC,GAAnB,CAAuBN,KAAvB,C;;;;AAAlBO,qC,SAAAA,K;AAAMC,oC,SAAAA,I;AACTC,oC,GAAK,E;;sCACNF,MAAMG,MAAN,GAAa,C;;;;;;uCACD,KAAKC,GAAL,CAASC,KAAT,CAAeC,KAAf,CAAqB,KAAKd,WAA1B,EAAsC,CAAC,CAAD,EAAGQ,MAAMO,GAAN,CAAU;AAAA,2CAAGC,EAAEC,EAAL;AAAA,iCAAV,CAAH,CAAtC,C;;;AAAXP,oC;;uCACM,KAAKQ,SAAL,CAAeR,IAAf,EAAoBD,IAApB,EAAyBD,KAAzB,C;;;AAEV,qCAAKN,GAAL,CAASiB,IAAT,GAAcT,IAAd;;;;;;;;;;;;;;;;;;;kGAGYA,I,EAAKD,I,EAAKD,K;;;;;;AACdY,iC,GAAE,C;;;sCAAEA,IAAEV,KAAKC,M;;;;;;uCACK,KAAKC,GAAL,CAASC,KAAT,CAAeC,KAAf,CAAqB,KAAKd,WAA1B,EAAsC,CAACU,KAAKU,CAAL,EAAQH,EAAT,EAAYT,MAAMO,GAAN,CAAU;AAAA,2CAAGC,EAAEC,EAAL;AAAA,iCAAV,CAAZ,CAAtC,C;;;AAAdI,uC;;sCACHA,WAAWA,QAAQV,MAAR,GAAe,C;;;;;AACzBD,qCAAKU,CAAL,EAAQE,QAAR,GAAiBD,OAAjB;;uCACM,KAAKH,SAAL,CAAeR,KAAKU,CAAL,EAAQE,QAAvB,EAAgCb,IAAhC,EAAqCD,KAArC,C;;;;;;;qCACDE,KAAKU,CAAL,EAAQG,W;;;;;AACTC,sC,GAAOd,KAAKU,CAAL,EAAQG,WAAR,CAAoBE,KAApB,CAA0B,GAA1B,C;;uCACY,KAAKpB,OAAL,CAAamB,OAAO,CAAP,CAAb,EAAwBA,OAAO,CAAP,CAAxB,EAAmCd,KAAKU,CAAL,CAAnC,EAA2CX,IAA3C,EAAgDD,KAAhD,C;;;AAAvBE,qCAAKU,CAAL,EAAQE,Q;;;AAPUF,mC;;;;;;;;;;;;;;;;;;;;;EArBLxB,U;;AAmC7B8B,OAAOC,OAAP,GAAe7B,cAAf","file":"menu.js","sourcesContent":["const Controller=require('egg').Controller;\n\nclass MenuController extends Controller{\n\n    constructor(){\n        super(...arguments);\n        this.roleMenuSql=\n            `select distinct m.* from t_menu m join t_role_menu rm on rm.menu_id=m.id \n                where m.parent_id=? and rm.role_id in (?) order by m.menu_order`;\n    }\n\n    async menuTree() {\n        const token =this.ctx.request.header['access-token'];\n        const {roles,user}=await this.service.redis.get(token);\n        let tree=[];\n        if(roles.length>0){\n            tree=await this.app.mysql.query(this.roleMenuSql,[1,roles.map(r=>r.id)]);\n            await this._menuTree(tree,user,roles);\n        }\n        this.ctx.body=tree;\n    }\n\n    async _menuTree(tree,user,roles){\n        for(let i=0;i<tree.length;i++){\n            const current=await this.app.mysql.query(this.roleMenuSql,[tree[i].id,roles.map(r=>r.id)]);\n            if(current && current.length>0){\n                tree[i].children=current;\n                await this._menuTree(tree[i].children,user,roles);\n            }else if(tree[i].load_method){\n                let method=tree[i].load_method.split('.');\n                tree[i].children=await this.service[method[0]][method[1]](tree[i],user,roles);\n            }\n        }\n    }\n\n}\n\nmodule.exports=MenuController;\n"]}