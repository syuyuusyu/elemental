{"version":3,"sources":["../../app/util.js"],"names":["toString","Object","prototype","isFunction","v","call","isObj","isArrsy","Array","remove","o","console","log","index","indexOf","splice","Function","createInterceptor","fn","scope","method","me","arg","arguments","apply","global","replaceArguments","args","callInstance","obj","defer","time","Promise","resolve","setTimeout","smartQuery","target","name","descriptor","oldValue","value","oldquery","app","mysql","query","_this","_oquery","modify","sql","paramsArr","newArg","paramsArrClone","concat","replace","w","current","shift","push","test","reject","then","response","lowCaseResult","_lowCaseObj","_lowCaseArray","lowCaseResponseBody","result","ctx","body","key","toLowerCase","arr","i","length","careateTree","array","idField","pidField","topId","_tree","leafArray","forEach","filter","a","_","findIndex","children","module","exports"],"mappings":"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","file":"util.js","sourcesContent":["\nconst toString=Object.prototype.toString;\nconst isFunction=function(v){\n    return toString.call(v)==\"[object Function]\";\n};\n\nconst isObj=function(v){\n    return toString.call(v)==\"[object Object]\";\n};\n\nconst isArrsy=function(v){\n    return toString.call(v)==\"[object Array]\";\n};\n\n// Array.prototype.indexOf = Array.prototype.indexOf ? Array.prototype.indexOf\n//     : function(o, from)  {\n//         from = from || 0;\n//         var len = this.length;\n//         from += (from < 0) ? len : 0;\n//         for (; from < len; from++) {\n//             if (this[from] === o)\n//                 return from;\n//         }\n//         return -1;\n//     };\n\nArray.prototype.remove = Array.prototype.remove ? Array.prototype.remove\n    : function(o)  {\n        console.log('reomve');\n        let index = this.indexOf(o);\n        if (index != -1) {\n            console.log(index);\n            this.splice(index, 1);\n        }\n    };\n\nFunction.prototype.createInterceptor=Function.prototype.createInterceptor?Function.prototype.createInterceptor\n    :function(fn,scope){\n        var method=this;\n        return !isFunction(fn)?\n            this:\n            function(){\n                var me=this,\n                    arg=arguments;\n                return (fn.apply(scope||me||global,arg)!==false)?\n                    method.apply(me||global,arg):\n                    null;\n            }\n    };\n\nFunction.prototype.replaceArguments=Function.prototype.replaceArguments?Function.prototype.replaceArguments\n    :function(fn){\n        var method=this;\n        return !isFunction(fn)?\n            this:\n            function(){\n                var me=this,\n                    arg=arguments,\n                    args=fn.apply(null,arg);\n                return method.apply(me||global,args);\n            }\n    };\n\nFunction.prototype.callInstance=function(obj){\n    var method=this;\n    return function(){\n        var arg=arguments;\n        return method.apply(obj,arg);\n    }\n};\n\n\nFunction.prototype.defer=function(){\n    var method=this;\n    var arg=arguments;\n    return function(time){\n        return new Promise((resolve)=>{\n            setTimeout(()=>resolve(method.apply(this,arg)),time);\n        });\n    }\n};\n\n\nfunction smartQuery(target, name, descriptor) {\n    var oldValue = descriptor.value;\n\n    descriptor.value = function() {\n        const oldquery=this.app.mysql.query;\n\n        return (function(_this,arg,_oquery){\n            _this.app.mysql.modify=true;\n            _this.app.mysql.query=_this.app.mysql.query.replaceArguments(function(sql,paramsArr){\n                const newArg=[],paramsArrClone=[].concat(paramsArr)\n                sql=sql.replace(/((?:where|and)\\s+[\\w\\.]+\\s*=\\s*\\?)|((?:where|and)\\s+[\\w\\.]+\\s+in\\s*\\(\\s*\\?\\s*\\))/g,(w)=>{\n                    let current=paramsArrClone.shift();\n                    if(current){\n                        newArg.push(current);\n                        return w;\n                    }else{\n                        return '';\n                    }\n                });\n                if(!/where/.test(sql)){\n                    sql=sql.replace('and','where');\n                }\n                return [sql,newArg];\n            });\n            return new Promise(function(resolve, reject){\n                resolve(oldValue.apply(_this, arg));\n\n            }).then(function(response){\n                _this.app.mysql.query=_oquery;\n                _this.app.mysql.modify=false;\n                return response;\n            });\n\n        })(this,arguments,oldquery)\n    };\n    return descriptor;\n}\n\nfunction lowCaseResult(target, name, descriptor) {\n    var oldValue = descriptor.value;\n    descriptor.value=function(){\n        var me=this;\n        var arg=arguments;\n        return new Promise(async function(resolve,reject){\n            resolve(oldValue.apply(me, arg));\n        }).then(function(response){\n            if(isObj(response)){\n                response=_lowCaseObj(response);\n            }else if(isArrsy(response)){\n                response=_lowCaseArray(response);\n            }else {\n                response=response;\n            }\n            return response;\n        });\n\n    }\n}\n\nfunction lowCaseResponseBody(target, name, descriptor) {\n    var oldValue = descriptor.value;\n    descriptor.value=function(){\n        var me=this;\n        var arg=arguments;\n        return new Promise(async function(resolve,reject) {\n            resolve(oldValue.apply(me, arg));\n        }).then(function(){\n            let result=me.ctx.body;\n            if(isObj(result)){\n                result=_lowCaseObj(result);\n            }else if(isArrsy(result)){\n                result=_lowCaseArray(result);\n            }else {\n                result=result;\n            }\n            me.ctx.body=result;\n        });\n\n    }\n}\n\nfunction _lowCaseObj(target){\n    let result={};\n    for(let key in target){\n        if(isObj(target[key])){\n            result[key.toLowerCase()]=_lowCaseObj(target[key]);\n        }else if(isArrsy(target[key])){\n            result[key.toLowerCase()]=_lowCaseArray(target[key]);\n        }else{\n            result[key.toLowerCase()]=target[key];\n        }\n    }\n    return result;\n}\n\nfunction _lowCaseArray(arr){\n    let result=[];\n    for(let i=0;i<arr.length;i++){\n        if(isObj(arr[i])){\n            result.push(_lowCaseObj(arr[i]))\n        }else if(isArrsy(arr[i])){\n            result.push(_lowCaseArray(arr[i]))\n        }else{\n            result.push(arr[i]);\n        }\n    }\n    return result;\n}\n\n\nfunction careateTree(array,idField,pidField,topId) {\n    function _tree(arr) {\n        const leafArray=[];\n        arr.forEach(_=>{\n            if(arr.filter(a=>a[pidField]===_[idField]).length===0){\n                leafArray.push(_);\n            }\n        });\n        if(leafArray.findIndex(_=>_[pidField]==topId)===-1){\n            console.log(arr.remove);\n            leafArray.forEach(_=>arr.remove(_));\n            leafArray.forEach(_=>{\n                for(let i=0;i<arr.length;i++){\n                    if(arr[i][idField]===_[pidField]){\n                        if(!arr[i].children){\n                            arr[i].children=[];\n                        }\n                        arr[i].children.push(_);\n                    }\n                }\n            });\n            _tree(arr);\n        }\n    }\n    _tree(array);\n    //console.log(array);\n    return array;\n\n}\n\n\n\n\nmodule.exports={smartQuery,lowCaseResult,lowCaseResponseBody,careateTree};"]}